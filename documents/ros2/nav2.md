# nav2-humble

## 基本概念

Nav2 是 ROS2 的导航框架，取代了 ROS1 的 Move Base。它采用高度模块化和可组合的设计理念，通过行为树（Behavior Tree）来编排各种导航任务。

其核心组件包括：
* **行为树 (BT Navigator)**: 负责调用规划器、控制器和恢复行为，以完成复杂的导航逻辑，而不仅仅是单一的路径规划。
* **规划器服务器 (Planner Server)**: 接收目标位姿，生成全局路径。
* **控制器服务器 (Controller Server)**: 接收全局路径，并计算速度指令以跟随路径。
* **恢复行为服务器 (Recovery Server)**: 在机器人陷入困境时执行恢复动作，如旋转或后退。
* **生命周期管理器 (Lifecycle Manager)**: 管理所有节点的启动、关闭和状态转换，确保系统的稳定性和可恢复性。
* **地图服务器/代价地图 (Map Server/Costmap)**: 提供环境的静态地图和动态更新的代价地图，用于路径规划和障碍物躲避。

## 与movebase的差异

| 特性 | Move Base (ROS1) | Nav2 (ROS2) |
| --- | --- | --- |
| **核心逻辑** | 固定的状态机 | 灵活、可定制的行为树 (Behavior Tree) |
| **通信** | Simple Action | ROS2 Action, Services, Topics |
| **节点管理** | 单一节点，管理复杂 | 多个独立的生命周期节点，模块化，易于管理和替换 |
| **任务执行** | 只能执行单一的`goToPose`任务 | 可通过行为树编排复杂任务，如路径跟随、航点跟随、原地恢复等 |
| **恢复行为** | 固定的恢复行为列表 | 可作为行为树节点灵活插入和配置 |
| **可扩展性** | 插件接口有限，定制困难 | 所有核心功能（规划器、控制器、恢复行为）均为插件，易于扩展和替换 |
| **鲁棒性** | 节点崩溃需手动重启 | 利用生命周期节点，可实现节点的自动重启和系统恢复 |

## 坑

* **配置复杂**: 参数文件众多且分散，例如 `nav2_params.yaml`。需要仔细理解每个参数的含义，特别是行为树的 XML 文件和各个插件的参数。
* **TF树和坐标系**: 对 TF 树的正确性要求极高。`map` -> `odom` -> `base_link` 的关系必须正确发布，否则路径规划和定位会完全失效。时间戳同步问题也容易导致 TF 错误。
* **代价地图膨胀层 (Inflation Layer)**: 膨胀半径 (`inflation_radius`) 和成本缩放因子 (`cost_scaling_factor`) 的设置对路径规划和机器人行为影响巨大。设置不当可能导致机器人过于保守，无法通过狭窄空间，或者过于激进，容易发生碰撞。
* **行为树 (BT) 调试**: 行为树的逻辑错误不易察觉。需要使用 Groot 等可视化工具来设计和调试 BT 的 XML 文件，以确保逻辑按预期执行。
* **DDS 配置**: ROS2 底层的 DDS 通信可能因网络环境或配置不当出现问题，导致节点间通信丢失或延迟，尤其是在数据量大的话题（如 `/map`, `/scan`）上。
* **控制器选择与调参**: 不同的控制器（如 DWB, MPPI）适用于不同的机器人模型和场景。需要对机器人的运动学模型有深入了解，并花费大量时间调整速度、加速度、路径跟踪容差等参数，否则机器人可能出现震荡、路径跟踪效果差等问题。